define("threejs-hex-map",["three"],function(t){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=6)}([function(e,n){e.exports=t},function(t,e,n){var r,o;r=[n,e,n(2)],void 0===(o=function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){if(this._width=t,this._height=e,this.data=[],this.halfWidth=this._width/2,this.halfHeight=this._height/2,t%2!=0||e%2!=0)throw new Error("With and height of grid must be divisible by 2");this.data=[]}return Object.defineProperty(t.prototype,"length",{get:function(){return this._width*this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),t.prototype.forEachQR=function(t){this._width;for(var e=this._height,n=-this.halfWidth;n<this.halfWidth;n++)for(var r=-this.halfHeight;r<this.halfHeight;r++){var o=n-r/2+(-e/2+r)%2/2,i=r;t(o,i,this.get(o,i))}return this},t.prototype.forEachIJ=function(t){this._width;for(var e=this._height,n=-this.halfWidth;n<this.halfWidth;n++)for(var r=-this.halfHeight;r<this.halfHeight;r++){var o=n-r/2+(-e/2+r)%2/2,i=r;t(n+this.halfWidth,r+this.halfHeight,o,i,this.get(o,i))}return this},t.prototype.init=function(t){var e=this;return t.forEach(function(t){e.add(t.q,t.r,t)}),this},t.prototype.initQR=function(t){var e=this;return this.forEachQR(function(n,r,o){return e.add(n,r,t(n,r,o))})},t.prototype.mapQR=function(e){var n=new t(this._width,this._height);return this.forEachQR(function(t,r,o){return n.add(t,r,e(t,r,o))}),n},t.prototype.toArray=function(){var t=new Array(this._width*this._height),e=0;for(var n in this.data)for(var r in this.data[n])t[e++]=this.data[n][r];return t},t.prototype.get=function(t,e){var n=this.data[t];return n?n[e]:void 0},t.prototype.getOrCreate=function(t,e,n){var r=this.data[t];if(!r)return this.data[t]=[],this.data[t][e]=n,n;var o=r[e];return o||(this.data[t][e]=n,n)},t.prototype.add=function(t,e,n){t in this.data?this.data[t][e]=n:(this.data[t]=[])[e]=n},t.prototype.neighbors=function(e,r,o){var i=this;return void 0===o&&(o=1),(1==o?t.NEIGHBOR_QRS:n.qrRange(o)).map(function(t){return i.get(e+t.q,r+t.r)}).filter(function(t){return void 0!==t})},t.prototype.surrounding=function(e,n){var r=this;return t.NEIGHBOR_QRS.map(function(t){return r.get(e+t.q,n+t.r)})},t.NEIGHBOR_QRS=[{q:1,r:-1},{q:1,r:0},{q:0,r:1},{q:-1,r:1},{q:-1,r:0},{q:0,r:-1}],t}();e.default=r}.apply(e,r))||(t.exports=o)},function(t,e,n){var r,o,i=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,i){function a(t){try{l(r.next(t))}catch(t){i(t)}}function s(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(a,s)}l((r=r.apply(t,e||[])).next())})},a=this&&this.__generator||function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};r=[n,e,n(0)],void 0===(o=function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=new n.FileLoader,o=new n.TextureLoader;function s(t){var e=t;return new Promise(function(t,n){r.load(e,function(e){t(e)},void 0,function(t){n(t)})})}function l(t,e,n){if(!e)return u(0,t);for(var r=t;r<e;r++)n(r)}function u(t,e){if(e){for(var n=[],r=t;r<e;r++)n.push(r);return n}return this.range(0,t)}e.loadTexture=function(t,e){return new Promise(function(n,r){o.load(t,function(t){n(t)},function(t){e&&e(t.loaded/t.total*100,t.total,t.loaded)},function(t){r(t)})})},e.loadFile=s,e.loadJSON=function(t){return i(this,void 0,void 0,function(){return a(this,function(e){return[2,s(t).then(function(t){return JSON.parse(t)})]})})},e.qrRange=function(t){var e=[];return l(-t,t+1,function(n){l(Math.max(-t,-n-t),Math.min(t,-n+t)+1,function(t){var r=-n-t;e.push({q:n,r:r})})}),e},e.forEachRange=l,e.shuffle=function(t){var e,n,r;for(r=t.length;r;r--)e=Math.floor(Math.random()*r),n=t[r-1],t[r-1]=t[e],t[e]=n;return t},e.range=u,e.flatMap=function(t,e){return[].concat.apply([],t.map(e))},e.sum=function(t){return t.reduce(function(t,e){return t+e},0)},e.qrEquals=function(t,e){return t.q==e.q&&t.r==e.r},e.minBy=function(t,e){return 0==t.length?null:1==t.length?t[0]:t.reduce(function(t,n){return e(n)<e(t)?n:t},t[0])},e.isInteger=function(t){return Math.floor(t)==t},e.flatten=function(t){return[].concat.apply([],t)}}.apply(e,r))||(t.exports=o)},function(t,e,n){var r,o;r=[n,e,n(0)],void 0===(o=function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=new n.Plane(new n.Vector3(0,0,1),0);function o(t,e){t.z=-1;var r=new n.Vector3(t.x,t.y,1);return t.unproject(e),r.unproject(e),r.sub(t).normalize(),new n.Raycaster(t,r)}e.qrToWorld=function(t,e,r){return void 0===r&&(r=1),new n.Vector3(Math.sqrt(3)*(t+e/2)*r,1.5*e*r,0)},e.qrToWorldX=function(t,e,n){return void 0===n&&(n=1),Math.sqrt(3)*(t+e/2)*n},e.qrToWorldY=function(t,e,n){return void 0===n&&(n=1),1.5*e*n},e.qrDistance=function(t,e){return(Math.abs(t.q-e.q)+Math.abs(t.q+t.r-e.q-e.r)+Math.abs(t.r-e.r))/2},e.pickingRay=o,e.mouseToWorld=function(t,e){return o(new n.Vector3(t.clientX/window.innerWidth*2-1,-t.clientY/window.innerHeight*2+1,.5),e).ray.intersectPlane(r,null)},e.screenToWorld=function(t,e,i){return o(new n.Vector3(t/window.innerWidth*2-1,-e/window.innerHeight*2+1,.5),i).ray.intersectPlane(r,null)},e.worldToScreen=function(t,e){var n=t.clone();return n.project(e),n.x=window.innerWidth/2+n.x*(window.innerWidth/2),n.y=window.innerHeight/2-n.y*(window.innerHeight/2),n},e.axialToCube=function(t,e){return{x:t,y:-t-e,z:e}},e.cubeToAxial=function(t,e,n){return{q:t,r:n}},e.roundToHex=function(t){var e=t.x,n=t.y,r=t.z,o=Math.round(e),i=Math.round(n),a=Math.round(r),s=Math.abs(o-e),l=Math.abs(i-n),u=Math.abs(a-r);return s>l&&s>u?o=-i-a:l>u?i=-o-a:a=-o-i,{x:o,y:i,z:a}}}.apply(e,r))||(t.exports=o)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isLand=function(t){return t>=0&&t<.75},e.isWater=function(t){return t<0},e.isHill=function(t){return t>=.375&&t<.75},e.isMountain=function(t){return t>=.75}}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r,o;r=[n,e,n(0)],void 0===(o=function(t,e,n){"use strict";function r(t,e,n,o){if((o||0)<=0)return[t,e,n];var i=e.clone().sub(t),a=t.clone().add(i.setLength(i.length()/2)),s=n.clone().sub(e),l=e.clone().add(s.setLength(s.length()/2)),u=t.clone().sub(n),c=n.clone().add(u.setLength(u.length()/2));return[].concat(r(a,l,c,o-1),r(c,l,n,o-1),r(a,c,t,o-1),r(l,a,e,o-1))}function o(t,e){return new n.Vector3(t*Math.sin(2*Math.PI*e),t*Math.cos(2*Math.PI*e),0)}function i(t){return new n.Vector3(1*Math.sin(2*Math.PI*t),1*Math.cos(2*Math.PI*t),0)}Object.defineProperty(e,"__esModule",{value:!0}),e.NE=32,e.E=16,e.SE=8,e.SW=4,e.W=2,e.NW=1,e.subdivideTriangle=r,e.createHexagon=function(t,e){for(var o=6*Math.pow(4,e),i=new Float32Array(3*o*3),a=0,s=new Float32Array(3*o*2),l=0,u=new Float32Array(3*o*1),c=0,f=[0,1,2,3,4,5].map(function(e){return new n.Vector3(t*Math.sin(2*Math.PI*(e/6)),t*Math.cos(2*Math.PI*(e/6)),0)}).concat([new n.Vector3(0,0,0)]),h=[0,6,1,1,6,2,2,6,3,3,6,4,4,6,5,5,6,0],d=[],v=0;v<h.length;v+=3){var p=f[h[v]],g=f[h[v+1]],m=f[h[v+2]];d=d.concat(r(p,g,m,e))}for(v=0;v<d.length;v++){i[a++]=d[v].x,i[a++]=d[v].y,i[a++]=d[v].z,s[l++]=.02+(d[v].x+t)/(2*t)*.96,s[l++]=.02+(d[v].y+t)/(2*t)*.96;var y=Math.sqrt(3)/2*t;u[c++]=d[v].length()>=y-.1?1:0}var x=new n.BufferGeometry;return x.addAttribute("position",new n.BufferAttribute(i,3)),x.addAttribute("uv",new n.BufferAttribute(s,2)),x.addAttribute("border",new n.BufferAttribute(u,1)),x},e.randomPointInHexagon=function(t){var e=Math.floor(6*Math.random()),r=o(t,(e+0)%6/6),i=new n.Vector3(0,0,0),a=o(t,(e+1)%6/6),s=Math.random(),l=Math.random(),u=Math.sqrt(s),c=Math.sqrt(l);return r.clone().multiplyScalar(1-u).add(i.clone().multiplyScalar(u*(1-c))).add(a.clone().multiplyScalar(l*u))},e.randomPointInHexagonEx=function(t,e){var r=Math.floor(6*Math.random()),o=a[r].clone(),i=new n.Vector3(0,0,0),s=a[(r+1)%6].clone(),l=Math.random(),u=Math.random(),c=Math.sqrt(l),f=Math.sqrt(u);return o.multiplyScalar(1-c).add(i.multiplyScalar(c*(1-f))).add(s.multiplyScalar(u*c)).multiplyScalar(e(r)*t)};var a=[i(0),i(1/6),i(2/6),i(.5),i(4/6),i(5/6)]}.apply(e,r))||(t.exports=o)},function(t,e,n){var r,o;r=[n,e,n(7),n(17),n(1)],void 0===(o=function(t,e,n,r,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MapMesh=n.default,e.DefaultMapViewController=r.default,e.Grid=o.default}.apply(e,r))||(t.exports=o)},function(t,e,n){var r,o,i=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),a=this&&this.__assign||function(){return(a=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},s=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,i){function a(t){try{l(r.next(t))}catch(t){i(t)}}function s(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(a,s)}l((r=r.apply(t,e||[])).next())})},l=this&&this.__generator||function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};r=[n,e,n(4),n(5),n(0),n(3),n(1),n(8),n(9),n(10),n(11),n(12)],void 0===(o=function(t,e,n,r,o,u,c,f,h,d,v,p){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var g=function(t){function e(e,r,i){var s=t.call(this)||this;return s.options=r,s._showGrid=!0,r.landFragmentShader||(r.landFragmentShader=f.LAND_FRAGMENT_SHADER),r.landVertexShader||(r.landVertexShader=h.LAND_VERTEX_SHADER),r.mountainsFragmentShader||(r.mountainsFragmentShader=d.MOUNTAINS_FRAGMENT_SHADER),r.mountainsVertexShader||(r.mountainsVertexShader=v.MOUNTAINS_VERTEX_SHADER),s.tiles=e.map(function(t){return a({bufferIndex:-1,isMountain:n.isMountain(t.height)},t)}),s.localGrid=new c.default(0,0).init(s.tiles),s.globalGrid=i||s.localGrid,r.hillsNormalTexture.wrapS=r.hillsNormalTexture.wrapT=o.RepeatWrapping,r.terrainAtlasTexture.wrapS=r.terrainAtlasTexture.wrapT=o.RepeatWrapping,r.undiscoveredTexture.wrapS=r.undiscoveredTexture.wrapT=o.RepeatWrapping,s.loaded=Promise.all([s.createLandMesh(s.tiles.filter(function(t){return!t.isMountain})),s.createMountainMesh(s.tiles.filter(function(t){return t.isMountain})),s.createTrees()]).catch(function(t){console.error("Could not create MapMesh",t)}),s}return i(e,t),Object.defineProperty(e.prototype,"showGrid",{get:function(){return this._showGrid},set:function(t){this._showGrid=t,this.land.material.uniforms.showGrid.value=t?1:0,this.mountains.material.uniforms.showGrid.value=t?1:0},enumerable:!0,configurable:!0}),e.prototype.replaceTextures=function(t){for(var e in t){var n=t[e];if(n){var r=this.options[e],o=r.wrapT,i=r.wrapS;r.copy(n),r.wrapT=o,r.wrapS=i,r.needsUpdate=!0}}},e.prototype.updateTiles=function(t){this.updateFogAndClouds(t),this.trees.updateTiles(t)},e.prototype.getTile=function(t,e){return this.localGrid.get(t,e)},e.prototype.updateFogAndClouds=function(t){var e=this,n=this.land.geometry.getAttribute("style"),r=this.mountains.geometry.getAttribute("style");t.forEach(function(t){var o=e.localGrid.get(t.q,t.r);if(o&&(t.fog!=o.fog||t.clouds!=o.clouds)){o.fog=t.fog,o.clouds=t.clouds;var i=o.isMountain?r:n;e.updateFogStyle(i,o.bufferIndex,t.fog,t.clouds)}}),n.needsUpdate=!0,r.needsUpdate=!0},e.prototype.updateFogStyle=function(t,e,n,r){var o=t.getY(e),i=n?1|o:-2&o,a=r?100+i:i%100;t.setY(e,a)},e.prototype.createTrees=function(){return s(this,void 0,void 0,function(){var t;return l(this,function(e){return t=this.trees=new p.default(this.tiles,this.globalGrid,{treeSize:this.options.treeSize||1.44,spritesheet:this.options.treeSpritesheet,spritesheetSubdivisions:this.options.treeSpritesheetSubdivisions,treesPerForest:this.options.treesPerForest||50,mapScale:this.options.scale||1,alphaTest:this.options.treeAlphaTest||.2,treeOptions:this.options.treeOptions}),this.add(t),[2]})})},e.prototype.createLandMesh=function(t){return s(this,void 0,void 0,function(){var e,n,r;return l(this,function(i){return e=this.options.terrainAtlas,n=m(t,this.globalGrid,0,this.options),r=new o.RawShaderMaterial({uniforms:{sineTime:{value:0},showGrid:{value:this._showGrid?1:0},camera:{type:"v3",value:new o.Vector3(0,0,0)},texture:{type:"t",value:this.options.terrainAtlasTexture},textureAtlasMeta:{type:"4f",value:new o.Vector4(e.width,e.height,e.cellSize,e.cellSpacing)},hillsNormal:{type:"t",value:this.options.hillsNormalTexture},coastAtlas:{type:"t",value:this.options.coastAtlasTexture},riverAtlas:{type:"t",value:this.options.riverAtlasTexture},mapTexture:{type:"t",value:this.options.undiscoveredTexture},transitionTexture:{type:"t",value:this.options.transitionTexture},lightDir:{type:"v3",value:new o.Vector3(.5,.6,-.5).normalize()},gridColor:{type:"c",value:void 0!==this.options.gridColor?this.options.gridColor:new o.Color(16777215)},gridWidth:{type:"f",value:void 0!==this.options.gridWidth?this.options.gridWidth:.02},gridOpacity:{type:"f",value:void 0!==this.options.gridOpacity?this.options.gridOpacity:.33}},vertexShader:this.options.landVertexShader,fragmentShader:this.options.landFragmentShader,side:o.FrontSide,wireframe:!1,transparent:!1}),this.land=new o.Mesh(n,r),this.land.frustumCulled=!1,this.add(this.land),[2]})})},e.prototype.createMountainMesh=function(t){return s(this,void 0,void 0,function(){var e,n,r;return l(this,function(i){return e=this.options.terrainAtlas,n=m(t,this.globalGrid,1,this.options),r=new o.RawShaderMaterial({uniforms:{sineTime:{value:0},showGrid:{value:this._showGrid?1:0},camera:{type:"v3",value:new o.Vector3(0,0,0)},texture:{type:"t",value:this.options.terrainAtlasTexture},textureAtlasMeta:{type:"4f",value:new o.Vector4(e.width,e.height,e.cellSize,e.cellSpacing)},hillsNormal:{type:"t",value:this.options.hillsNormalTexture},mapTexture:{type:"t",value:this.options.undiscoveredTexture},lightDir:{type:"v3",value:new o.Vector3(.5,.6,-.5).normalize()},gridColor:{type:"c",value:void 0!==this.options.gridColor?this.options.gridColor:new o.Color(16777215)},gridWidth:{type:"f",value:void 0!==this.options.gridWidth?this.options.gridWidth:.02},gridOpacity:{type:"f",value:void 0!==this.options.gridOpacity?this.options.gridOpacity:.33}},vertexShader:this.options.mountainsVertexShader,fragmentShader:this.options.mountainsFragmentShader,side:o.FrontSide,wireframe:!1,transparent:!1}),this.mountains=new o.Mesh(n,r),this.mountains.frustumCulled=!1,this.add(this.mountains),[2]})})},e}(o.Group);function m(t,e,i,a){var s=a.scale||1,l=r.createHexagon(s,i),c=new o.InstancedBufferGeometry,f=a.terrainAtlas;c.maxInstancedCount=t.length,c.addAttribute("position",l.attributes.position),c.addAttribute("uv",l.attributes.uv),c.addAttribute("border",l.attributes.border);var h=t.map(function(t){return u.qrToWorld(t.q,t.r,s)}),d=new o.InstancedBufferAttribute(new Float32Array(2*h.length),2,1);d.copyVector2sArray(h),c.addAttribute("offset",d);var v=f.cellSize,p=(f.cellSpacing,f.width/v);function g(t){var e=f.textures[t];return e.cellY*p+e.cellX}var m=t.map(function(t,r){if(!f.textures[t.terrain])throw new Error("Terrain '"+t.terrain+"' not in texture atlas\r\n"+JSON.stringify(f));var i=g(t.terrain),a=t.fog?1:0,s=t.clouds?1:0,l=1*a+10*(n.isHill(t.height)?1:0)+100*s,u=function(t,e){function r(e,r){var o=t.get(e,r);return!!o&&n.isWater(o.height)}function o(t){return t?"1":"0"}if(r(e.q,e.r))return 0;var i=o(r(e.q+1,e.r-1)),a=o(r(e.q+1,e.r)),s=o(r(e.q,e.r+1)),l=o(r(e.q-1,e.r+1)),u=o(r(e.q-1,e.r)),c=o(r(e.q,e.r-1));return parseInt(i+a+s+l+u+c,2)}(e,t),c=function(t,e){if(!e.rivers)return 0;var n={count:0},r=x(y(t,e,e.q+1,e.r-1,n)),o=x(y(t,e,e.q+1,e.r,n)),i=x(y(t,e,e.q,e.r+1,n)),a=x(y(t,e,e.q-1,e.r+1,n)),s=x(y(t,e,e.q-1,e.r,n)),l=x(y(t,e,e.q,e.r-1,n));return parseInt(r+o+i+a+s+l,2)}(e,t);return t.bufferIndex=r,new o.Vector4(i,l,u,c)}),b=new o.InstancedBufferAttribute(new Float32Array(4*h.length),4,1);b.copyVector4sArray(m),c.addAttribute("style",b);for(var w=new o.InstancedBufferAttribute(new Float32Array(3*t.length),3,1),M=new o.InstancedBufferAttribute(new Float32Array(3*t.length),3,1),_=0;_<t.length;_++)for(var T=e.surrounding(t[_].q,t[_].r),S=0;S<T.length;S++){var A=T[S];(S>2?M:w).array[3*_+S%3]=A?g(A.terrain):-1}return c.addAttribute("neighborsEast",w),c.addAttribute("neighborsWest",M),c}function y(t,e,r,o,i){var a=t.get(r,o);if(a&&a.rivers&&e&&e.rivers){for(var s=0,l=e.rivers;s<l.length;s++)for(var u=l[s],c=0,f=a.rivers;c<f.length;c++){var h=f[c],d=u.riverIndex==h.riverIndex&&1==Math.abs(u.riverTileIndex-h.riverTileIndex),v=u.riverIndex!=h.riverIndex&&d;if(d||v)return!0}return!1}return!(!a||!n.isWater(a.height)||0!=i.count)&&(i.count++,!0)}function x(t){return t?"1":"0"}e.default=g}.apply(e,r))||(t.exports=o)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LAND_FRAGMENT_SHADER="\n//\n// Fragment Shader for Land\n//\n\nprecision mediump float;\n\nuniform float sineTime;\nuniform float showGrid;\nuniform float zoom;\nuniform sampler2D texture;\nuniform sampler2D hillsNormal;\nuniform sampler2D coastAtlas;\nuniform sampler2D riverAtlas;\nuniform sampler2D mapTexture;\nuniform sampler2D transitionTexture;\nuniform mat3 normalMatrix;\n\nuniform vec3 gridColor;\nuniform float gridWidth;\nuniform float gridOpacity;\n\n// (width, height, cellSize, cellSpacing)\nuniform vec4 textureAtlasMeta;\n\nvarying vec2 vUV;\nvarying vec2 vTexCoord;\nvarying vec3 vPosition;\nvarying float vExtra;\nvarying float vTerrain;\nvarying float vFogOfWar;\nvarying float vHill;\nvarying float vHidden;\nvarying vec2 vOffset;\nvarying vec2 vCoastTextureCell;\nvarying vec2 vRiverTextureCell;\nvarying vec3 vLightDirT;\nvarying vec3 vNeighborsEast;\nvarying vec3 vNeighborsWest;\n\nconst vec3 cameraPos = vec3(0, -25.0, 25.0);\nconst vec3 lightDir = vec3(0.0, -1.0, -1.0);\nconst vec3 lightAmbient = vec3(0.3, 0.3, 0.3);\nconst vec3 lightDiffuse = vec3(1.3, 1.3, 1.3);\n\nconst float hillsNormalMapScale = 0.3; //0.1;\n\nvec2 cellIndexToUV(float idx) {\n    float atlasWidth = textureAtlasMeta.x;\n    float atlasHeight = textureAtlasMeta.y;\n    float cellSize = textureAtlasMeta.z;\n    float cols = atlasWidth / cellSize - 1e-6; // subtract small epsilon to avoid edge cases that cause flickering\n    float rows = atlasHeight / cellSize;\n    float x = mod(idx, cols);\n    float y = floor(idx / cols);\n\n    //return vec2(uv.x * w + u, 1.0 - (uv.y * h + v));\n    return vec2(x / cols + vUV.x / cols, 1.0 - (y / rows + (1.0 - vUV.y) / rows));\n}\n\n/**\n * Uses the texture of a neighboring terrain to blend the given color.\n * @parma color to blend with\n * @param terrain texture atlas index\n * @param sector 0 - 5 (NE - NW) \n */\nvec4 terrainTransition(vec4 inputColor, float terrain, float sector) {\n    if (vTerrain <= 1.0 && terrain > 1.0) return inputColor;\n    vec2 otherUV = cellIndexToUV(terrain);\n    vec2 blendMaskUV = vec2(sector/6.0 + vUV.x / 6.0, 1.0 - vUV.y / 6.0);\n    vec4 color = texture2D(texture, otherUV);\n    vec4 blend = texture2D(transitionTexture, blendMaskUV);\n    float a = min(blend.r, clamp(terrain - vTerrain, 0.0, 1.0));\n    \n    return mix(inputColor, color, a);\n}\n\nvoid main() {\n    // LAND\n    vec4 texColor = texture2D(texture, vTexCoord);\n    vec3 normal = vec3(0.0, 1.0, 0.0);\n    vec2 normalMapUV = vPosition.xy * hillsNormalMapScale;\n\n    /// Transitions to neighboring tiles\n    texColor = terrainTransition(texColor, vNeighborsEast.x, 0.0);\n    texColor = terrainTransition(texColor, vNeighborsEast.y, 1.0);\n    texColor = terrainTransition(texColor, vNeighborsEast.z, 2.0);\n    texColor = terrainTransition(texColor, vNeighborsWest.x, 3.0);\n    texColor = terrainTransition(texColor, vNeighborsWest.y, 4.0);\n    texColor = terrainTransition(texColor, vNeighborsWest.z, 5.0);\n\n    // HILL\n    if (vHill > 0.0) {\n        normal = normalize((texture2D(hillsNormal, normalMapUV).xyz * 2.0) - 1.0);\n        normal = mix(normal, vec3(0.0, 1.0, 0.0), vExtra * vExtra * vExtra); // fade out towards tile edges\n    }\n\n    vec3 lightDir = vLightDirT;\n    float lambertian = max(dot(lightDir, normal), 0.0);\n    //lambertian = sqrt(lambertian);\n\n    vec3 color = lightAmbient * texColor.xyz + lambertian * texColor.xyz * lightDiffuse;\n    gl_FragColor = vec4(color, 1.0);    \n    \n    // comment out following line to show normal vector visualization\n    //gl_FragColor = vec4((normal.x + 1.0 / 2.0, 0.0, 1.0), (normal.y + 1.0 / 2.0, 0.0, 1.0), (normal.z + 1.0 / 2.0, 0.0, 1.0), 1.0);\n    \n    // comment out following line to show normal map texture (UV) coordinates\n    //gl_FragColor = vec4(mod(normalMapUV.x, 1.0), mod(normalMapUV.y, 1.0), 0.0, 1.0);\n\n    // Coast\n    vec2 coastUv = vec2(vCoastTextureCell.x / 8.0 + vUV.x / 8.0, 1.0 - (vCoastTextureCell.y / 8.0 + vUV.y / 8.0));\n    vec4 coastColor = texture2D(coastAtlas, coastUv);\n\n    if (coastColor.w > 0.0) {\n        vec3 coast = lightAmbient * coastColor.xyz + lambertian * coastColor.xyz * lightDiffuse;\n        gl_FragColor = mix(gl_FragColor, vec4(coast, 1.0), coastColor.w);\n    }\n    \n    // River\n    vec2 riverUv = vec2(vRiverTextureCell.x / 8.0 + vUV.x / 8.0, 1.0 - (vRiverTextureCell.y / 8.0 + vUV.y / 8.0));\n    vec4 riverColor = texture2D(riverAtlas, riverUv);\n\n    if (riverColor.w > 0.0) {\n        vec3 river = lightAmbient * riverColor.xyz + lambertian * riverColor.xyz * lightDiffuse;\n        //gl_FragColor = mix(gl_FragColor, vec4(river, 1.0), riverColor.w);\n        gl_FragColor = mix(gl_FragColor, vec4(river, 1.0), riverColor.w);\n    }\n\n    if (showGrid > 0.0 && vExtra > 1.0 - gridWidth) { // hex border\n        gl_FragColor = mix(vec4(gridColor, 1.0), gl_FragColor, 1.0 - gridOpacity);\n    }\n\n    // FOW\n    gl_FragColor = gl_FragColor * (vFogOfWar > 0.0 && vHidden == 0.0 ? 0.66 : 1.0);\n\n    // Map Texture for hidden tiles\n    if (vHidden > 0.0) {\n        gl_FragColor = texture2D(mapTexture, vec2(vPosition.x * 0.05, vPosition.y * 0.05));\n    }    \n}\n"}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LAND_VERTEX_SHADER="\n//\n// Vertex Shader for Land\n//\nprecision mediump float;\n\nuniform float sineTime; // oscillating time [-1.0, 1.0]\nuniform float zoom; // camera zoom factor\nuniform float size; // quadratic map size (i.e. size=10 means 10x10 hexagons)\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\nuniform mat4 modelMatrix;\nuniform vec3 camera; // camera position in world space\n\n// (width, height, cellSize, cellSpacing)\nuniform vec4 textureAtlasMeta;\n\nuniform vec3 lightDir;\n\nattribute vec3 position; // position of one of the hexagon's vertices\nattribute vec2 offset; // world position offset for the entire hexagon (tile)\nattribute vec2 uv; // texture coordinates\nattribute float border; // border = distance from hexagon center (0.0 = center, 1.0 = border)\n\n// style.x = texture atlas cell index\n// style.y = \"decimal bitmask\" (fog=1xx, hills=x1x, clouds=xx1)\n// style.z = coast texture index (0 - 64)\n// style.w = river texture index (0 - 64)\nattribute vec4 style;\n\n// type of terrain on surrounding tiles as texture atlas cell index (like style.x)\n// is -1 if there is no neighbor (e.g. at the border of the map)\nattribute vec3 neighborsEast; // x = NE, y = E, z = SE\nattribute vec3 neighborsWest; // x = SW, y = W, z = NW \n\nvarying vec3 vPosition;\nvarying vec2 vTexCoord;\nvarying vec2 vUV;\nvarying float vExtra;\nvarying float vTerrain; // texture cell\nvarying float vFogOfWar; // 1.0 = shadow, 0.0 = visible\nvarying float vHidden; // 1.0 = hidden, 0.0 = visible\nvarying float vHill;\nvarying vec2 vOffset;\nvarying vec2 vCoastTextureCell;\nvarying vec2 vRiverTextureCell;\nvarying vec3 vLightDirT;\n\nvarying vec3 vNeighborsEast;\nvarying vec3 vNeighborsWest;\n\nvec2 cellIndexToUV(float idx) {\n    float atlasWidth = textureAtlasMeta.x;\n    float atlasHeight = textureAtlasMeta.y;\n    float cellSize = textureAtlasMeta.z;\n    float cols = atlasWidth / cellSize;\n    float rows = atlasHeight / cellSize;\n    float x = mod(idx, cols);\n    float y = floor(idx / cols);\n\n    //return vec2(uv.x * w + u, 1.0 - (uv.y * h + v));\n    return vec2(x / cols + uv.x / cols, 1.0 - (y / rows + (1.0 - uv.y) / rows));\n}\n\nmat3 tangentSpace(vec3 normal_ws, vec3 tangent, mat4 worldMatrix) {\n    vec3 binormal = cross(tangent, normal_ws);\n    mat3 M;\n    M[0] = normalize(binormal);\n    M[1] = normalize(tangent);\n    M[2] = normalize(normal_ws);\n    \n    return mat3(modelMatrix) * M;\n}\n\nvoid main() {\n    vec3 pos = vec3(offset.x + position.x, offset.y + position.y, 0);\n\n    // its a hill if style's 2nd decimal is 1, i.e. any number matching x1x, e.g. 10, 11, 110\n    float hill = floor(mod(style.y / 10.0, 10.0)); // 0 = no, 1 = yes\n\n    if (hill > 0.0 && border < 0.75) { // hill\n        //pos.z = 0.1 + (0.5 + sin(uv.s + pos.s * 2.0) * 0.5) * 0.25;\n        vHill = 1.0;\n    } else {\n        vHill = 0.0;\n    }\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n    vPosition = pos;\n    vOffset = offset;\n\n    vUV = uv;\n    vTexCoord = cellIndexToUV(style.x);\n    vCoastTextureCell = vec2(mod(style.z, 8.0), floor(style.z / 8.0));\n    vRiverTextureCell = vec2(mod(style.w, 8.0), floor(style.w / 8.0));\n\n    vExtra = border;\n    vFogOfWar = mod(style.y, 10.0) == 1.0 ? 1.0 : 0.0;   // style.y < 100.0 ? 10.0 : (style.y == 1.0 || style.y == 11.0 ? 1.0 : 0.0);\n    vHidden = style.y >= 100.0 ? 1.0 : 0.0;\n    \n    mat3 T = tangentSpace(vec3(0.0, -1.0, 0.0), vec3(0.0, 0.0, 1.0), modelMatrix);\n    vLightDirT = normalize(T * lightDir);\n    \n    vNeighborsEast = neighborsEast;\n    vNeighborsWest = neighborsWest;\n    \n    vTerrain = style.x;\n}\n"}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MOUNTAINS_FRAGMENT_SHADER="\n//\n// Fragment Shader for Land\n//\n\nprecision highp float;\nuniform float sineTime;\nuniform float showGrid;\nuniform float zoom;\nuniform sampler2D texture;\nuniform sampler2D hillsNormal;\nuniform sampler2D mapTexture;\n\nuniform vec3 gridColor;\nuniform float gridWidth;\nuniform float gridOpacity;\n\nvarying vec2 vTexCoord;\nvarying vec3 vPosition;\nvarying float vExtra;\nvarying float vFogOfWar;\nvarying float vHill;\nvarying float vHidden;\nvarying vec2 vOffset;\nvarying vec3 vLightDirT;\nvarying vec3 vNeighborsEast;\nvarying vec3 vNeighborsWest;\n\nconst vec3 cameraPos = vec3(0, -25.0, 25.0);\nconst vec3 lightPos = vec3(1000.0, 1000.0, 1000.0);\nconst vec3 lightAmbient = vec3(0.08, 0.08, 0.08);\nconst vec3 lightDiffuse = vec3(1.3, 1.3, 1.3);\n\nvoid main() {\n    // LAND\n    vec4 texColor = texture2D(texture, vTexCoord);\n    vec3 normal = vec3(0.0, 1.0, 0.0);\n\n    normal = normalize((texture2D(hillsNormal, vTexCoord * 1.5 + vOffset * 0.5).xyz * 2.0) - 1.0);\n\n    //vec3 lightDir = normalize(lightPos - vPosition);\n    vec3 lightDir = vLightDirT;\n    float lambertian = max(dot(lightDir, normal), 0.0);\n\n    vec3 color = lightAmbient + lambertian * texColor.xyz * lightDiffuse;\n    gl_FragColor = vec4(color, 1.0);\n\n    if (showGrid > 0.0 && vExtra > 1.0 - gridWidth) { // hex border\n        gl_FragColor = mix(vec4(gridColor, 1.0), gl_FragColor, 1.0 - gridOpacity);\n    }\n\n    // FOW\n    gl_FragColor = gl_FragColor * (vFogOfWar > 0.0 ? 0.66 : 1.0);\n\n    // Map Texture for hidden tiles\n    if (vHidden > 0.0) {\n        gl_FragColor = texture2D(mapTexture, vec2(vPosition.x * 0.05, vPosition.y * 0.05));\n    } \n}\n"}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MOUNTAINS_VERTEX_SHADER='\n//\n// Vertex Shader for Land\n//\n\n\nprecision highp float;\n\nuniform float sineTime; // oscillating time [-1.0, 1.0]\nuniform float zoom; // camera zoom factor\nuniform float size; // quadratic map size (i.e. size=10 means 10x10 hexagons)\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\nuniform mat4 modelMatrix;\nuniform vec3 camera; // camera position in world space\n\nuniform vec3 lightDir;\n\n// (width, height, cellSize, cellSpacing)\nuniform vec4 textureAtlasMeta;\n\nattribute vec3 position; // position of one of the hexagon\'s vertices\nattribute vec2 offset; // world position offset for the entire hexagon (tile)\nattribute vec2 uv; // texture coordinates\nattribute float border; // border = distance from hexagon center (0.0 = center, 1.0 = border)\n\n// style.x = texture atlas cell index\n// style.y = "decimal bitmask" (fog=1xx, hills=x1x, clouds=xx1)\n// style.z = coast texture index (0 - 64)\n// style.w = river texture index (0 - 64)\nattribute vec2 style;\n\n// type of terrain on surrounding tiles as texture atlas cell index (like style.x)\n// is -1 if there is no neighbor (e.g. at the border of the map)\nattribute vec3 neighborsEast; // x = NE, y = E, z = SE\nattribute vec3 neighborsWest; // x = SW, y = W, z = NW \n\nvarying vec3 vPosition;\nvarying vec2 vTexCoord;\nvarying float vExtra;\nvarying float vFogOfWar; // 1.0 = shadow, 0.0 = no shadow\nvarying float vHill;\nvarying float vHidden; // 1.0 = hidden, 0.0 = visible\nvarying vec2 vOffset;\nvarying vec3 vLightDirT;\nvarying vec3 vNeighborsEast;\nvarying vec3 vNeighborsWest;\n\nvec2 cellIndexToUV(float idx) {\n    float atlasWidth = textureAtlasMeta.x;\n    float atlasHeight = textureAtlasMeta.y;\n    float cellSize = textureAtlasMeta.z;\n    float cols = atlasWidth / cellSize;\n    float rows = atlasHeight / cellSize;\n    float x = mod(idx, cols);\n    float y = floor(idx / cols);\n\n    return vec2(x / cols + uv.x / cols, 1.0 - (y / rows + uv.y / rows));\n}\n\nmat3 tangentSpace(vec3 normal_ws, vec3 tangent, mat4 worldMatrix) {\n    vec3 binormal = cross(tangent, normal_ws);\n    mat3 M;\n    M[0] = normalize(binormal);\n    M[1] = normalize(tangent);\n    M[2] = normalize(normal_ws);\n    \n    return mat3(modelMatrix) * M;\n}\n\nvoid main() {\n    vec3 pos = vec3(offset.x + position.x, offset.y + position.y, 0);\n\n    if (border < 0.95 && style.y < 100.0) {\n        pos.z = 0.2 + (0.5 + sin(uv.s + pos.s * 2.0) * 0.5) * 0.5;\n    }\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n    vPosition = pos;\n    vOffset = offset;\n\n    vTexCoord = cellIndexToUV(style.x);\n\n    vExtra = border;\n    vFogOfWar = mod(style.y, 10.0) == 1.0 ? 1.0 : 0.0;   // style.y < 100.0 ? 10.0 : (style.y == 1.0 || style.y == 11.0 ? 1.0 : 0.0);\n    vHidden = style.y >= 100.0 ? 1.0 : 0.0;\n    \n    vNeighborsEast = neighborsEast;\n    vNeighborsWest = neighborsWest;\n    \n    mat3 T = tangentSpace(vec3(0.0, 1.0, 0.0), vec3(0.0, 0.0, 1.0), modelMatrix);\n    vLightDirT = normalize(T * lightDir);\n}\n'}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r,o,i=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),a=this&&this.__assign||function(){return(a=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};r=[n,e,n(0),n(1),n(2),n(3),n(13),n(14),n(15)],void 0===(o=function(t,e,n,r,o,s,l,u,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var f=function(t){function e(e,n,r){var o=t.call(this)||this;return o._forestTiles=e.filter(function(t){return void 0!==t.treeIndex}).map(function(t){return a({bufferIndex:-1},t)}),o._globalGrid=n,o._options=a({},r),o._trees=new h(n,o._forestTiles,r),o.add(o._trees),o}return i(e,t),e.prototype.updateTiles=function(t){this._trees.updateTiles(t.filter(function(t){return void 0!==t.treeIndex}))},e}(n.Object3D);e.default=f;var h=function(t){function e(e,n,o){var i=t.call(this)||this;return i._globalGrid=e,i._grid=new r.default(0,0).init(n),i._texture=o.spritesheet,i._tiles=n,i._options=o,i.create(),i}return i(e,t),e.prototype.updateTiles=function(t){for(var e=this._alphaAttr,n=0,r=t;n<r.length;n++){var o=r[n],i=this._grid.get(o.q,o.r),a=o.clouds?0:1;if(o.clouds!=i.clouds){for(var s=0;s<this._options.treesPerForest;s++)e.setZ(i.bufferIndex+s,a);i.clouds=o.clouds}}e.needsUpdate=!0},e.prototype.create=function(){this._points=new n.Points(this.createGeometry(),this.createMaterial()),this.add(this._points)},e.prototype.treeSize=function(t){return this._options.treeOptions&&void 0!==this._options.treeOptions[t]?(this._options.treeOptions[t].scale||1)*this._options.treeSize:this._options.treeSize},e.prototype.numTreesPerForest=function(t){return this._options.treeOptions&&void 0!==this._options.treeOptions[t]?this._options.treeOptions[t].treesPerForest:this._options.treesPerForest},e.prototype.createGeometry=function(){var t=this,e=new n.BufferGeometry,r=this._options,i=(r.treeSize,r.mapScale),a=o.flatMap(this._tiles,function(e,n){var r=t.numTreesPerForest(e.treeIndex);e.bufferIndex=n*r;for(var o=new Array(r),a=0;a<r;a++){var l=s.qrToWorld(e.q,e.r,i),u=c.randomPointOnCoastTile(c.waterAdjacency(t._globalGrid,e),i);o[a]=l.add(u).setZ(.12)}return o}),l=new n.BufferAttribute(new Float32Array(3*a.length),3).copyVector3sArray(a);e.addAttribute("position",l);var u=this._options.spritesheetSubdivisions,f=o.flatMap(this._tiles,function(e){for(var r=t.numTreesPerForest(e.treeIndex),o=t.treeSize(e.treeIndex),i=new Array(r),a=0;a<r;a++)i[a]=new n.Vector3(e.treeIndex*u+Math.floor(Math.random()*u),o,e.clouds?0:1);return i});return this._alphaAttr=new n.BufferAttribute(new Float32Array(3*a.length),3).copyVector3sArray(f),e.addAttribute("params",this._alphaAttr),e},e.prototype.createMaterial=function(){var t=this._options,e=(t.treeSize,t.mapScale,t.spritesheetSubdivisions),r={uniforms:{texture:{type:"t",value:this._texture},spritesheetSubdivisions:{type:"f",value:e},size:{type:"f",value:(this._options.mapScale||1)*this._options.treeSize},scale:{type:"f",value:window.innerHeight/2},alphaTest:{type:"f",value:this._options.alphaTest}},transparent:!0,vertexShader:l.TREES_VERTEX_SHADER,fragmentShader:u.TREES_FRAGMENT_SHADER};return new n.RawShaderMaterial(r)},e}(n.Object3D)}.apply(e,r))||(t.exports=o)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TREES_VERTEX_SHADER="\nprecision mediump float;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float size;\nuniform float scale;\n\nattribute vec3 position;\nattribute vec3 params; // x = spritesheet x, y = spritesheet y, z = alpha\nattribute vec3 color;\n\nvarying vec3 vParams; // x = sprite index, y = size, z = visible?\nvarying vec3 vColor;\n\nvoid main() {\n    vParams = params;\n\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    gl_Position = projectionMatrix * mvPosition;\n    gl_PointSize = params.y * ( scale / - mvPosition.z );\n    \n    vColor = color;\n}\n"}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TREES_FRAGMENT_SHADER="\nprecision mediump float;\n\nuniform sampler2D texture;\nuniform float alphaTest;\nuniform float spritesheetSubdivisions;\n\nvarying vec3 vParams;\nvarying vec3 vColor;\n\nvec2 spriteIndexToUV(float idx, vec2 uv) {\n    float cols = spritesheetSubdivisions - 1e-6; // subtract small epsilon to avoid edge cases that cause flickering\n    float rows = spritesheetSubdivisions;\n    \n    float x = mod(idx, cols);\n    float y = floor(idx / cols);\n\n    return vec2(x / cols + uv.x / cols, 1.0 - (y / rows + (uv.y) / rows));\n}\n\nvoid main() {\n    vec2 uv = spriteIndexToUV(vParams.x, gl_PointCoord);\n    vec4 diffuse = texture2D(texture, uv);\n    \n    float alpha = diffuse.w * vParams.z;\n    \n    if (alpha < alphaTest) discard;\n    \n    gl_FragColor = vec4(diffuse.xyz, alpha);\n}\n"}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r,o,i=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,i){function a(t){try{l(r.next(t))}catch(t){i(t)}}function s(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(a,s)}l((r=r.apply(t,e||[])).next())})},a=this&&this.__generator||function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};r=[n,e,n(16),n(4),n(2),n(1),n(5)],void 0===(o=function(t,e,n,r,o,s,l){"use strict";function u(t,e){return i(this,void 0,void 0,function(){var n;return a(this,function(i){return n=new s.default(t,t).mapQR(function(t,n){return e(t,n)}),[2,function(t){var e=t.toArray(),n=Math.max(1,Math.round(Math.sqrt(t.length)/4));return o.shuffle(e.filter(function(e){return function(t,e){var n=e.neighbors(t.q,t.r);return r.isMountain(t.height)&&n.filter(function(t){return r.isLand(t.height)}).length>3}(e,t)})).slice(0,n).map(function(e){var n=[e],o=e;for(;!r.isWater(o.height)&&n.length<20;){var s=i(t.neighbors(o.q,o.r)).filter(function(t){return!a(t,n)});if(0==s.length)return console.info("Aborted river generation",n,o),n;var l=s[Math.max(s.length-1,Math.floor(1.2*Math.random()))];n.push(l),o=l}return n}).forEach(function(t,e){t.forEach(function(n,r){r<t.length-1&&(n.rivers=[{riverIndex:e,riverTileIndex:r}])})}),t;function i(t){return t.sort(function(t,e){return e.height-t.height})}function a(t,e){for(var n=0,r=e;n<r.length;n++){var o=r[n];if(o.q==t.q&&o.r==t.r)return!0}return!1}}(n)]})})}Object.defineProperty(e,"__esModule",{value:!0}),e.generateMap=u,e.generateRandomMap=function(t,e){return i(this,void 0,void 0,function(){return a(this,function(r){return n.seed(Date.now()+Math.random()),[2,u(t,function(t,r){return e(t,r,function(t,e){return(n.simplex2(t/10,e/10)+n.perlin2(t/5,e/5)+n.perlin2(t/30,e/30))/3*2}(t,r))})]})})},e.waterAdjacency=function(t,e){function n(e,n){var o=t.get(e,n);return!!o&&r.isWater(o.height)}return{NE:n(e.q+1,e.r-1),E:n(e.q+1,e.r),SE:n(e.q,e.r+1),SW:n(e.q-1,e.r+1),W:n(e.q-1,e.r),NW:n(e.q,e.r-1)}},e.randomPointOnCoastTile=function(t,e){return void 0===e&&(e=1),l.randomPointInHexagonEx(e,function(e){return 0==(e=(6-e+2)%6)&&t.NE?.5:1==e&&t.E?.5:2==e&&t.SE?.5:3==e&&t.SW?.5:4==e&&t.W?.5:5==e&&t.NW?.5:1})}}.apply(e,r))||(t.exports=o)},function(t,e,n){var r;void 0===(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e,n){this.x=t,this.y=e,this.z=n}return t.prototype.dot2=function(t,e){return this.x*t+this.y*e},t.prototype.dot3=function(t,e,n){return this.x*t+this.y*e+this.z*n},t}(),r=[new n(1,1,0),new n(-1,1,0),new n(1,-1,0),new n(-1,-1,0),new n(1,0,1),new n(-1,0,1),new n(1,0,-1),new n(-1,0,-1),new n(0,1,1),new n(0,-1,1),new n(0,1,-1),new n(0,-1,-1)],o=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],i=new Array(512),a=new Array(512);function s(t){t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(var e=0;e<256;e++){var n;n=1&e?o[e]^255&t:o[e]^t>>8&255,i[e]=i[e+256]=n,a[e]=a[e+256]=r[n%12]}}e.seed=s,s(0);var l=.5*(Math.sqrt(3)-1),u=(3-Math.sqrt(3))/6,c=1/3,f=1/6;function h(t){return t*t*t*(t*(6*t-15)+10)}function d(t,e,n){return(1-n)*t+n*e}e.simplex2=function(t,e){var n,r,o=(t+e)*l,s=Math.floor(t+o),c=Math.floor(e+o),f=(s+c)*u,h=t-s+f,d=e-c+f;h>d?(n=1,r=0):(n=0,r=1);var v=h-n+u,p=d-r+u,g=h-1+2*u,m=d-1+2*u,y=a[(s&=255)+i[c&=255]],x=a[s+n+i[c+r]],b=a[s+1+i[c+1]],w=.5-h*h-d*d,M=.5-v*v-p*p,_=.5-g*g-m*m;return 70*((w<0?0:(w*=w)*w*y.dot2(h,d))+(M<0?0:(M*=M)*M*x.dot2(v,p))+(_<0?0:(_*=_)*_*b.dot2(g,m)))},e.simplex3=function(t,e,n){var r,o,s,l,u,h,d=(t+e+n)*c,v=Math.floor(t+d),p=Math.floor(e+d),g=Math.floor(n+d),m=(v+p+g)*f,y=t-v+m,x=e-p+m,b=n-g+m;y>=x?x>=b?(r=1,o=0,s=0,l=1,u=1,h=0):y>=b?(r=1,o=0,s=0,l=1,u=0,h=1):(r=0,o=0,s=1,l=1,u=0,h=1):x<b?(r=0,o=0,s=1,l=0,u=1,h=1):y<b?(r=0,o=1,s=0,l=0,u=1,h=1):(r=0,o=1,s=0,l=1,u=1,h=0);var w=y-r+f,M=x-o+f,_=b-s+f,T=y-l+2*f,S=x-u+2*f,A=b-h+2*f,C=y-1+3*f,E=x-1+3*f,P=b-1+3*f,O=a[(v&=255)+i[(p&=255)+i[g&=255]]],D=a[v+r+i[p+o+i[g+s]]],z=a[v+l+i[p+u+i[g+h]]],W=a[v+1+i[p+1+i[g+1]]],F=.6-y*y-x*x-b*b,V=.6-w*w-M*M-_*_,q=.6-T*T-S*S-A*A,N=.6-C*C-E*E-P*P;return 32*((F<0?0:(F*=F)*F*O.dot3(y,x,b))+(V<0?0:(V*=V)*V*D.dot3(w,M,_))+(q<0?0:(q*=q)*q*z.dot3(T,S,A))+(N<0?0:(N*=N)*N*W.dot3(C,E,P)))},e.perlin2=function(t,e){var n=Math.floor(t),r=Math.floor(e);t-=n,e-=r;var o=a[(n&=255)+i[r&=255]].dot2(t,e),s=a[n+i[r+1]].dot2(t,e-1),l=a[n+1+i[r]].dot2(t-1,e),u=a[n+1+i[r+1]].dot2(t-1,e-1),c=h(t);return d(d(o,l,c),d(s,u,c),h(e))},e.perlin3=function(t,e,n){var r=Math.floor(t),o=Math.floor(e),s=Math.floor(n);t-=r,e-=o,n-=s;var l=a[(r&=255)+i[(o&=255)+i[s&=255]]].dot3(t,e,n),u=a[r+i[o+i[s+1]]].dot3(t,e,n-1),c=a[r+i[o+1+i[s]]].dot3(t,e-1,n),f=a[r+i[o+1+i[s+1]]].dot3(t,e-1,n-1),v=a[r+1+i[o+i[s]]].dot3(t-1,e,n),p=a[r+1+i[o+i[s+1]]].dot3(t-1,e,n-1),g=a[r+1+i[o+1+i[s]]].dot3(t-1,e-1,n),m=a[r+1+i[o+1+i[s+1]]].dot3(t-1,e-1,n-1),y=h(t),x=h(e),b=h(n);return d(d(d(l,v,y),d(u,p,y),b),d(d(c,g,y),d(f,m,y),b),x)}}.apply(e,[n,e]))||(t.exports=r)},function(t,e,n){var r,o;r=[n,e,n(3),n(0)],void 0===(o=function(t,e,n,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(e,n,r){void 0===r&&(r=t.easeInOutQuad),this.durationMs=e,this.update=n,this.easingFunction=r,this.progress=0}return t.prototype.animate=function(t){return this.progress=this.progress+1e3*t/this.durationMs,this.update(this.easingFunction(this.progress)),this.progress>=1},t.easeInOutQuad=function(t){return(t/=.5)<1?.5*t*t:-.5*(--t*(t-2)-1)},t.easeLinear=function(t){return t},t}(),i=function(){function t(){var t=this;this.lastDrag=null,this.debugText=null,this.selectedQR={q:0,r:0},this.animations=[],this.onAnimate=function(e){for(var n=t.animations,r=0;r<n.length;r++){var o=n[r];o.animate(e)&&(n[r]=n[n.length-1],n[n.length-1]=o,n.pop())}},this.onKeyDown=function(e){32==e.keyCode&&(console.log("center view on QR("+t.selectedQR.q+","+t.selectedQR.r+")"),t.panCameraTo(t.selectedQR,600))},this.onMouseDown=function(e){t.pickingCamera=t.controls.getCamera().clone(),t.mouseDownPos=n.screenToWorld(e.clientX,e.clientY,t.pickingCamera),t.dragStartCameraPos=t.controls.getCamera().position.clone()},this.onMouseEnter=function(e){1===e.buttons&&t.onMouseDown(e)},this.onMouseMove=function(e){if(t.mouseDownPos){var o=n.screenToWorld(e.clientX,e.clientY,t.pickingCamera),i=(t.lastDrag=o.sub(t.mouseDownPos).multiplyScalar(-1)).clone().add(t.dragStartCameraPos);t.controls.getCamera().position.copy(i)}if(window.innerHeight==screen.height&&!t.mouseDownPos){var a=new r.Vector2(e.clientX,e.clientY),s=new r.Vector2(window.innerWidth/2,window.innerHeight/2),l=a.clone().sub(s);Math.abs(l.x)>s.x-20||Math.abs(l.y)>s.y-20?t.controls.setScrollDir(l.x,-l.y):t.controls.setScrollDir(0,0)}},this.onMouseUp=function(e){if(!t.lastDrag||t.lastDrag.length()<.1){var r=n.screenToWorld(e.clientX,e.clientY,t.controls.getCamera()),o=t.controls.pickTile(r);o&&(t.controls.selectTile(o),t.selectedQR=o,t.showDebugInfo())}t.mouseDownPos=null,t.lastDrag=null},this.onMouseOut=function(e){t.mouseDownPos=null,t.controls.setScrollDir(0,0)}}return Object.defineProperty(t.prototype,"debugOutput",{set:function(t){this.debugText=t},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){var n=this;this.controls=t,document.addEventListener("keydown",this.onKeyDown,!1),e.addEventListener("mousedown",this.onMouseDown,!1),e.addEventListener("mousemove",this.onMouseMove,!1),e.addEventListener("mouseup",this.onMouseUp,!1),e.addEventListener("mouseout",this.onMouseOut,!1),e.addEventListener("mouseenter",this.onMouseEnter,!1),e.addEventListener("touchstart",function(t){n.onMouseDown(t.touches[0]),t.preventDefault()},!1),e.addEventListener("touchmove",function(t){n.onMouseMove(t.touches[0]),t.preventDefault()},!1),e.addEventListener("touchend",function(t){return n.onMouseUp(t.touches[0]||t.changedTouches[0])},!1),setInterval(function(){return n.showDebugInfo()},200),this.controls.setOnAnimateCallback(this.onAnimate)},t.prototype.addAnimation=function(t){this.animations.push(t)},t.prototype.showDebugInfo=function(){if(null!=this.debugText){var t=this.selectedQR,e=n.qrToWorld(t.q,t.r),r=this.controls.getViewCenter();this.controls.pickTile(e);this.debugText.innerHTML="Selected Tile: QR("+t.q+", "+t.r+"), \n            XY("+e.x.toFixed(2)+", "+e.y.toFixed(2)+")\n            &nbsp; &bull; &nbsp; Camera Looks At (Center): XYZ("+r.x.toFixed(2)+", "+r.y.toFixed(2)+", "+r.z.toFixed(2)+")"}},t.prototype.panCameraTo=function(t,e){var n=this,r=this.controls.getCamera().position.clone(),i=this.controls.getCameraFocusPosition(t);this.addAnimation(new o(e,function(t){n.controls.getCamera().position.copy(r.clone().lerp(i,t))}))},t}();e.default=i}.apply(e,r))||(t.exports=o)}])});